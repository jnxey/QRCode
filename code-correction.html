<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OpenCV.js 精确三角形检测</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
    <style>
        canvas { border:1px solid black; }
    </style>
</head>
<body>
<h2>上传图片检测三角形</h2>
<input type="file" id="fileInput">
<br><br>
<canvas id="canvasOutput"></canvas>

<script>
  let inputElement = document.getElementById('fileInput');
  let canvas = document.getElementById('canvasOutput');
  let ctx = canvas.getContext('2d');

  inputElement.addEventListener('change', (e) => {
    let file = e.target.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(event) {
      let img = new Image();
      img.onload = function() {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        detectTriangles();
      }
      img.src = event.target.result;
    }
    reader.readAsDataURL(file);
  });

  function detectTriangles() {
    let src = cv.imread(canvas);
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
    cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);

    let edges = new cv.Mat();
    cv.Canny(gray, edges, 50, 150);

    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(edges, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    for (let i = 0; i < contours.size(); i++) {
      let cnt = contours.get(i);

      // 过滤太小的轮廓
      if (cv.contourArea(cnt) < 100) {
        cnt.delete();
        continue;
      }

      let approx = new cv.Mat();
      let epsilon = 0.02 * cv.arcLength(cnt, true); // 精度可调
      cv.approxPolyDP(cnt, approx, epsilon, true);

      // 顶点=3 且凸形才判定为三角形
      if (approx.rows === 3 && cv.isContourConvex(approx)) {
        // 抗锯齿描边
        let color = new cv.Scalar(0, 255, 0, 255);
        let contourVec = new cv.MatVector();
        contourVec.push_back(approx);
        cv.drawContours(src, contourVec, 0, color, 2, cv.LINE_AA); // LINE_AA 抗锯齿
        contourVec.delete();
      }

      approx.delete();
      cnt.delete();
    }

    cv.imshow('canvasOutput', src);

    src.delete();
    gray.delete();
    edges.delete();
    contours.delete();
    hierarchy.delete();
  }
</script>
</body>
</html>
