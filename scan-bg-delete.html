<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>纯色背景抠图</title>
    <script src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>
<body>
<h2>上传图片抠出前景</h2>
<input type="file" id="fileInput" accept="image/*">
<br><br>
<canvas id="canvasInput"></canvas>
<canvas id="canvasOutput"></canvas>

<script>
  // 等待 OpenCV.js 加载
  cv['onRuntimeInitialized'] = () => {
    const fileInput = document.getElementById('fileInput');
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const img = new Image();
        img.onload = () => {
          processImage(img);
        };
        img.src = URL.createObjectURL(file);
      }
    });

    function processImage(img) {
      // 设置输入 canvas
      const canvasInput = document.getElementById('canvasInput');
      canvasInput.width = img.width;
      canvasInput.height = img.height;
      const ctx = canvasInput.getContext('2d');
      ctx.drawImage(img, 0, 0);

      // 读取图片
      let src = cv.imread(canvasInput);
      let dst = new cv.Mat();
      let hsv = new cv.Mat();

      // 转 HSV
      cv.cvtColor(src, hsv, cv.COLOR_RGBA2RGB);
      cv.cvtColor(hsv, hsv, cv.COLOR_RGB2HSV);

      // 设置背景颜色范围（可修改白色或绿布）
      let lower = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [0, 0, 200, 0]);
      let upper = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [180, 30, 255, 255]);
      let mask = new cv.Mat();
      cv.inRange(hsv, lower, upper, mask);

      // 反转 mask
      let mask_inv = new cv.Mat();
      cv.bitwise_not(mask, mask_inv);

      // 提取前景
      cv.bitwise_and(src, src, dst, mask_inv);

      // 可选：边缘处理去噪
      let kernel = cv.Mat.ones(3, 3, cv.CV_8U);
      cv.morphologyEx(mask_inv, mask_inv, cv.MORPH_OPEN, kernel);

      // 显示结果
      const canvasOutput = document.getElementById('canvasOutput');
      canvasOutput.width = img.width;
      canvasOutput.height = img.height;
      cv.imshow(canvasOutput, dst);

      // 释放内存
      src.delete(); dst.delete(); hsv.delete();
      lower.delete(); upper.delete(); mask.delete(); mask_inv.delete(); kernel.delete();
    }
  }
</script>
</body>
</html>
