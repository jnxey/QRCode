<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>YOLOv8 ONNX Detection Web</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        canvas { border: 1px solid black; }
    </style>
</head>
<body>

<h2>YOLOv8 ONNX Detection Web</h2>
<input type="file" id="fileInput" accept="image/*">
<br><br>
<canvas id="canvas"></canvas>

<script>
  const IMG_SIZE = 640; // 模型输入尺寸
  // COCO 类别示例，可根据你的模型修改
  const CLASS_NAMES = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];

  let session;
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  // 加载 ONNX 模型
  async function loadModel() {
    session = await ort.InferenceSession.create('yolov8n.onnx');
    console.log('ONNX model loaded');
  }
  loadModel();

  // 图片上传处理
  document.getElementById('fileInput').addEventListener('change', async (evt) => {
    const file = evt.target.files[0];
    if (!file || !session) return;

    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = async () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);

      // ---------------- 预处理 ----------------
      let scale = Math.min(IMG_SIZE / img.width, IMG_SIZE / img.height);
      let new_w = Math.floor(img.width * scale);
      let new_h = Math.floor(img.height * scale);

      // 创建离屏 canvas
      let offCanvas = document.createElement('canvas');
      offCanvas.width = IMG_SIZE;
      offCanvas.height = IMG_SIZE;
      let offCtx = offCanvas.getContext('2d');

      // 填充灰色背景
      offCtx.fillStyle = 'rgb(114,114,114)';
      offCtx.fillRect(0,0,IMG_SIZE,IMG_SIZE);

      // 绘制缩放图片
      offCtx.drawImage(img, 0, 0, new_w, new_h);

      // 获取像素数据并归一化
      let imageData = offCtx.getImageData(0,0,IMG_SIZE,IMG_SIZE);
      let data = imageData.data; // RGBA Uint8ClampedArray

      // HWC -> CHW
      let chw = new Float32Array(3*IMG_SIZE*IMG_SIZE);
      for(let y=0;y<IMG_SIZE;y++){
        for(let x=0;x<IMG_SIZE;x++){
          let idx = (y*IMG_SIZE + x)*4;
          chw[y*IMG_SIZE + x] = data[idx]/255.0; // R
          chw[IMG_SIZE*IMG_SIZE + y*IMG_SIZE + x] = data[idx+1]/255.0; // G
          chw[2*IMG_SIZE*IMG_SIZE + y*IMG_SIZE + x] = data[idx+2]/255.0; // B
        }
      }

      // ---------------- 推理 ----------------
      const inputTensor = new ort.Tensor('float32', chw, [1,3,IMG_SIZE,IMG_SIZE]);
      const feeds = {};
      feeds[session.inputNames[0]] = inputTensor;

      const output = await session.run(feeds);
      let pred = output[session.outputNames[0]].data; // Float32Array
      let numBoxes = pred.length / 6;
      pred = Array.from(pred);

      // ---------------- 绘制结果 ----------------
      ctx.lineWidth = 2;
      ctx.font = '16px sans-serif';
      ctx.strokeStyle = 'red';
      ctx.fillStyle = 'red';

      for(let i=0;i<numBoxes;i++){
        let x1 = pred[i*6 + 0] / scale;
        let y1 = pred[i*6 + 1] / scale;
        let x2 = pred[i*6 + 2] / scale;
        let y2 = pred[i*6 + 3] / scale;
        let conf = pred[i*6 + 4];
        let cls = pred[i*6 + 5];

        if(conf < 0.25) continue; // 阈值可调

        let clsName = CLASS_NAMES[cls] || cls;
        ctx.strokeRect(x1,y1,x2-x1,y2-y1);
        ctx.fillText(`${clsName} ${conf.toFixed(2)}`, x1, Math.max(0,y1-5));
      }

    }
  });
</script>
</body>
</html>
