<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>桌面筹码自动标记</title>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        canvas { border: 1px solid #ccc; margin-top: 10px; }
    </style>
</head>
<body>

<h2>上传桌面图片，自动标记筹码</h2>
<input type="file" id="fileInput" accept="image/*">
<canvas id="canvas"></canvas>

<script>
  document.getElementById('fileInput').addEventListener('change', function(e){
    let file = e.target.files[0];
    if(!file) return;
    let img = new Image();
    img.onload = () => processImage(img);
    img.src = URL.createObjectURL(file);
  });

  function processImage(img){
    let canvas = document.getElementById('canvas');
    canvas.width = img.width;
    canvas.height = img.height;
    let ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);

    let src = cv.imread(canvas);

    // 1. 转灰度 + 高斯模糊
    let gray = new cv.Mat();
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
    cv.GaussianBlur(gray, gray, new cv.Size(7,7), 2);

    // 2. 自适应阈值 + 反色，让筹码凸显
    let thresh = new cv.Mat();
    cv.adaptiveThreshold(gray, thresh, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C,
      cv.THRESH_BINARY_INV, 11, 3);

    // 3. 可选：膨胀+腐蚀，闭运算去掉噪点
    let kernel = cv.getStructuringElement(cv.MORPH_ELLIPSE, new cv.Size(3,3));
    cv.morphologyEx(thresh, thresh, cv.MORPH_CLOSE, kernel);

    // 4. 找轮廓
    let contours = new cv.MatVector();
    let hierarchy = new cv.Mat();
    cv.findContours(thresh, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);

    // 5. 遍历轮廓，筛选圆形筹码
    for(let i=0; i<contours.size(); i++){
      let cnt = contours.get(i);
      let area = cv.contourArea(cnt);
      if(area < 1000) continue; // 忽略小噪点

      let perimeter = cv.arcLength(cnt, true);
      let circularity = 4 * Math.PI * area / (perimeter * perimeter);
      if(circularity < 0.6) continue; // 保证较圆

      // 使用最小外接圆拟合
      let circle = cv.minEnclosingCircle(cnt);
      let center = circle.center;
      let radius = circle.radius;

      // 画圆
      ctx.beginPath();
      ctx.strokeStyle = 'red';
      ctx.lineWidth = 3;
      ctx.arc(center.x, center.y, radius, 0, 2*Math.PI);
      ctx.stroke();

      cnt.delete();
    }

    // 释放内存
    src.delete(); gray.delete(); thresh.delete(); contours.delete(); hierarchy.delete(); kernel.delete();
  }
</script>

</body>
</html>
